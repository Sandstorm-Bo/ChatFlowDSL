name: "发票服务流程"
entry_point: "state_start_invoice"

states:
  - id: "state_start_invoice"
    triggers:
      - type: regex
        value: ".*(发票|invoice).*"
      - type: regex
        value: ".*(开票|开发票|开个票|开张票|开增值税|增值税发票|电子发票|纸质发票).*"
      - type: regex
        value: ".*(要票|要发票|打票|打发票|票据|小票|报销).*"
      - type: regex
        value: ".*(receipt|bill).*"
    actions:
      - type: respond
        text: "您好，需要为您申请开具发票吗？请提供需要开票的订单号。"
    transitions:
      - target: "state_collect_order_number"

  - id: "state_collect_order_number"
    actions:
      - type: respond
        text: "请提供需要开具发票的订单号，例如 A1234567890。"
      - type: wait_for_input
    transitions:
      - condition:
          all:
            - type: regex
              value: "[A-Z0-9]{10,}"
        target: "state_verify_order_for_invoice"
      - target: "state_invalid_order_format"

  - id: "state_invalid_order_format"
    actions:
      - type: respond
        text: "您输入的订单号格式不正确，请重新输入。"
    transitions:
      - target: "state_collect_order_number"

  - id: "state_verify_order_for_invoice"
    actions:
      - type: extract_variable
        source: user_input
        regex: "(?P<order_id>[A-Z0-9]{10,})"
        target: "session.order_id"
      - type: api_call
        endpoint: "database://invoices/check_eligibility"
        params:
          order_id: "{{session.order_id}}"
        save_to: "session.invoice_check"
    transitions:
      - condition:
          # 假设API返回: {"eligible": true, "message": "..."}
          all:
            - type: variable_equals
              variable: "session.invoice_check.eligible"
              value: true
        target: "state_collect_invoice_info"
      - target: "state_invoice_not_eligible"

  - id: "state_invoice_not_eligible"
    actions:
      - type: respond
        text: "抱歉，根据查询，您的订单 {{session.order_id}} 因“{{session.invoice_check.message}}”无法开具发票。"
    transitions:
      - target: "state_end_invoice"

  - id: "state_collect_invoice_info"
    actions:
      - type: respond
        text: "请提供发票抬头和税号，格式为：抬头:XXX, 税号:XXX"
    transitions:
      - target: "state_process_invoice_request"

  - id: "state_process_invoice_request"
    actions:
      - type: respond
        text: "收到，请按“抬头:XXX, 税号:XXX”的格式提供发票信息。"
      - type: wait_for_input
    transitions:
      - condition:
          all:
            - type: regex
              # 简单的正则，实际应更严格
              value: ".*(抬头|title).*(税号|tax).*"
        target: "state_submit_invoice_request"
      - target: "state_invalid_invoice_info"
  
  - id: "state_invalid_invoice_info"
    actions:
      - type: respond
        text: "您提供的发票信息格式不正确，请按“抬头:XXX, 税号:XXX”的格式提供。"
    transitions:
      - target: "state_process_invoice_request"

  - id: "state_submit_invoice_request"
    actions:
      - type: extract_variable
        source: user_input
        regex: "抬头:(?P<title>.*),.*税号:(?P<tax_id>.*)"
        target: "session.invoice_info" # 会存成一个字典
      - type: api_call
        endpoint: "database://invoices/create"
        params:
          order_id: "{{session.order_id}}"
          user_id: "{{session.user_id}}"
          title: "{{session.invoice_info.title}}"
          tax_id: "{{session.invoice_info.tax_id}}"
          amount: "{{session.invoice_check.order.total_price if session.invoice_check.order else 0}}"
        save_to: "session.invoice_result"
      - type: respond
        text: |
          {{session.invoice_result.message}}
          发票编号：{{session.invoice_result.invoice_id}}
    transitions:
      - target: "state_end_invoice"

  - id: "state_end_invoice"
    actions:
      - type: respond
        text: "感谢您的咨询。"
    transitions:
      # 如果用户继续提到发票相关内容，则回到发票入口
      - condition:
          all:
            - type: regex
              value: ".*(发票|invoice).*"
        target: "state_start_invoice"
      # 其他情况也回到入口，由入口决定是否再次进入发票流程
      - target: "state_start_invoice"
