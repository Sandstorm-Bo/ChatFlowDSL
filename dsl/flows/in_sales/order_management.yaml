name: "å”®ä¸­è®¢å•ç®¡ç†æµç¨‹"
entry_point: "state_start_order_management"

states:
  - id: "state_start_order_management"
    triggers:
      - type: regex
        value: ".*(è®¢å•|ç‰©æµ|å¿«é€’|å‘è´§|é…é€).*"
    actions:
      - type: respond
        text: |
          æ‚¨å¥½ï¼æˆ‘å¯ä»¥å¸®æ‚¨ï¼š
          1. æŸ¥è¯¢è®¢å•çŠ¶æ€å’Œç‰©æµä¿¡æ¯
          2. æŸ¥çœ‹æ‚¨çš„æ‰€æœ‰è®¢å•

          è¯·å‘Šè¯‰æˆ‘æ‚¨çš„è®¢å•å·ï¼ˆå¦‚ï¼šA1234567890ï¼‰ï¼Œæˆ–è€…è¯´"æŸ¥çœ‹æˆ‘çš„è®¢å•"ã€‚
    transitions:
      - target: "state_collect_order_info"

  - id: "state_collect_order_info"
    actions:
      - type: wait_for_input
    transitions:
      # ç”¨æˆ·æƒ³æŸ¥çœ‹æ‰€æœ‰è®¢å•
      - condition:
          all:
            - type: regex
              value: ".*(æ‰€æœ‰|å…¨éƒ¨|æˆ‘çš„).*è®¢å•.*"
        target: "state_list_all_orders"
      # ç”¨æˆ·æä¾›äº†è®¢å•å·
      - condition:
          all:
            - type: regex
              value: "[A-Z][0-9]{10}"
        target: "state_query_specific_order"
      - target: "state_invalid_order_format"

  # åˆ—å‡ºç”¨æˆ·çš„æ‰€æœ‰è®¢å•
  - id: "state_list_all_orders"
    actions:
      - type: api_call
        endpoint: "database://orders/list"
        params:
          user_id: "U001"  # å®é™…åº”ç”¨ä¸­åº”è¯¥ä»sessionä¸­è·å–å½“å‰ç”¨æˆ·ID
        save_to: "session.user_orders"
      - type: respond
        text: |
          æ‚¨çš„è®¢å•åˆ—è¡¨å¦‚ä¸‹ï¼š
          {{session.order_list_text}}

          è¯·å‘Šè¯‰æˆ‘è®¢å•å·ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æŸ¥è¯¢è¯¦ç»†ä¿¡æ¯ã€‚
    transitions:
      - target: "state_collect_order_info"

  # æŸ¥è¯¢ç‰¹å®šè®¢å•
  - id: "state_query_specific_order"
    actions:
      - type: extract_variable
        source: user_input
        regex: "(?P<order_id>[A-Z][0-9]{10})"
        target: "session.order_id"
      - type: api_call
        endpoint: "database://orders/get"
        params:
          order_id: "{{session.order_id}}"
        save_to: "session.current_order"
      - type: respond
        text: |
          ğŸ“¦ è®¢å•è¯¦æƒ…

          è®¢å•å·ï¼š{{session.current_order.order_id}}
          å•†å“åç§°ï¼š{{session.current_order.product_name}}
          æ•°é‡ï¼š{{session.current_order.quantity}} ä»¶
          æ€»ä»·ï¼šÂ¥{{session.current_order.total_price}}
          è®¢å•çŠ¶æ€ï¼š{{session.order_status_text}}
          é…é€åœ°å€ï¼š{{session.current_order.shipping_address}}
          {{session.tracking_info}}

          æ‚¨éœ€è¦å…¶ä»–å¸®åŠ©å—ï¼Ÿ
    transitions:
      - condition:
          all:
            - type: regex
              value: ".*(å–æ¶ˆ|ä¸è¦|é€€).*"
        target: "state_confirm_cancel"
      - condition:
          all:
            - type: regex
              value: ".*(é€€æ¬¾|é€€è´§).*"
        target: "state_redirect_to_refund"
      - target: "state_end_order_management"

  # ç¡®è®¤å–æ¶ˆè®¢å•
  - id: "state_confirm_cancel"
    actions:
      - type: respond
        text: |
          æ‚¨ç¡®å®šè¦å–æ¶ˆè®¢å• {{session.order_id}} å—ï¼Ÿ

          è®¢å•çŠ¶æ€ï¼š{{session.order_status_text}}

          æç¤ºï¼š
          - å·²å‘è´§çš„è®¢å•æ— æ³•å–æ¶ˆï¼Œéœ€è¦ç”³è¯·é€€æ¬¾
          - å–æ¶ˆåæ— æ³•æ¢å¤

          è¯·å›å¤"ç¡®è®¤å–æ¶ˆ"æˆ–"ä¸å–æ¶ˆ"
    transitions:
      - condition:
          all:
            - type: regex
              value: ".*(ç¡®è®¤|æ˜¯çš„|ç¡®å®š).*å–æ¶ˆ.*"
        target: "state_cancel_order"
      - target: "state_end_order_management"

  # æ‰§è¡Œå–æ¶ˆè®¢å•
  - id: "state_cancel_order"
    actions:
      - type: respond
        text: |
          æ­£åœ¨ä¸ºæ‚¨å–æ¶ˆè®¢å•...

          è®¢å• {{session.order_id}} å·²æˆåŠŸå–æ¶ˆï¼
          é€€æ¬¾å°†åœ¨3-5ä¸ªå·¥ä½œæ—¥å†…åŸè·¯è¿”å›ã€‚

          å¦‚æœ‰ç–‘é—®ï¼Œè¯·éšæ—¶è”ç³»å®¢æœã€‚
    transitions:
      - target: "state_end_order_management"

  # é‡å®šå‘åˆ°é€€æ¬¾æµç¨‹
  - id: "state_redirect_to_refund"
    actions:
      - type: respond
        text: |
          å¥½çš„ï¼Œå·²å‘è´§çš„è®¢å•éœ€è¦é€šè¿‡é€€æ¬¾æµç¨‹å¤„ç†ã€‚

          æˆ‘å°†ä¸ºæ‚¨è½¬æ¥åˆ°é€€æ¬¾æœåŠ¡...
          ï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°é€€æ¬¾æµç¨‹ï¼‰
    transitions:
      - target: "state_end_order_management"

  - id: "state_invalid_order_format"
    actions:
      - type: respond
        text: |
          æŠ±æ­‰ï¼Œè®¢å•å·æ ¼å¼ä¸æ­£ç¡®ã€‚

          è®¢å•å·æ ¼å¼ç¤ºä¾‹ï¼šA1234567890ï¼ˆ1ä¸ªå­—æ¯+10ä¸ªæ•°å­—ï¼‰

          è¯·é‡æ–°è¾“å…¥æ‚¨çš„è®¢å•å·ï¼Œæˆ–è¯´"æŸ¥çœ‹æˆ‘çš„è®¢å•"ã€‚
    transitions:
      - target: "state_collect_order_info"

  - id: "state_end_order_management"
    actions:
      - type: respond
        text: "æ„Ÿè°¢å’¨è¯¢ï¼Œè¿˜æœ‰å…¶ä»–éœ€è¦å¸®åŠ©çš„å—ï¼Ÿ"
