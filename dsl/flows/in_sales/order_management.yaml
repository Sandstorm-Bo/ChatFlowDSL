name: "å”®ä¸­è®¢å•ç®¡ç†æµç¨‹"
entry_point: "state_start_order_management"

states:
  - id: "state_start_order_management"
    triggers:
      - type: regex
        value: ".*(è®¢å•|ç‰©æµ|å¿«é€’|å‘è´§|é…é€).*"
      - type: regex
        value: ".*(æŸ¥|æŸ¥è¯¢|æŸ¥çœ‹|çœ‹çœ‹|çœ‹ä¸‹|çœ‹ä¸€ä¸‹).*(è®¢å•|ç‰©æµ|å¿«é€’|åŒ…è£¹|å¿«ä»¶|è¿å•).*"
      - type: regex
        value: ".*(order|shipping|delivery|track).*(status|ä¿¡æ¯|æƒ…å†µ).*"
    actions:
      - type: respond
        text: |
          æ‚¨å¥½ï¼æˆ‘å¯ä»¥å¸®æ‚¨ï¼š
          1. æŸ¥è¯¢è®¢å•çŠ¶æ€å’Œç‰©æµä¿¡æ¯
          2. æŸ¥çœ‹æ‚¨çš„æ‰€æœ‰è®¢å•

          è¯·å‘Šè¯‰æˆ‘æ‚¨çš„è®¢å•å·ï¼ˆå¦‚ï¼šA1234567890ï¼‰ï¼Œæˆ–è€…è¯´â€œæŸ¥çœ‹æˆ‘çš„è®¢å•â€ã€‚
          å¦‚æœä¸€æ—¶æƒ³ä¸èµ·è®¢å•å·ï¼Œä¹Ÿå¯ä»¥ç”¨â€œå¤§æ¦‚è´­ä¹°æ—¶é—´ + å•†å“åç§°â€æ¥æè¿°ï¼Œä¾‹å¦‚â€œä¸Šå‘¨ä¹°çš„ä¸€ä¸ªæ°´æ¯â€ã€‚
    transitions:
      - condition:
          all:
            - type: regex
              value: ".*(ä¸çŸ¥é“|å¿˜è®°|è®°ä¸ä½).*(è®¢å•å·|å•å·).*"
        target: "state_no_order_id_help"
      - condition:
          all:
            - type: regex
              value: "1[3-9][0-9]{9}"
        target: "state_phone_not_supported"
      - condition:
          all:
            - type: regex
              value: ".*(æ˜¨å¤©|å‰å¤©|ä¸Šå‘¨|ä¸Šä¸ªæœˆ|æœ€è¿‘|åˆšæ‰|åˆšåˆš|ä¸Šæ¬¡|ä¹°çš„|ä¹°äº†|ä¸‹å•).*"
        target: "state_search_order_by_info"
      - condition:
          all:
            - type: regex
              value: ".*(æ‰€æœ‰|å…¨éƒ¨|æˆ‘çš„).*è®¢å•.*"
        target: "state_list_all_orders"
      - condition:
          all:
            - type: regex
              value: "[A-Z0-9]{8,12}"
        target: "state_query_specific_order"
      - target: "state_invalid_order_format"

  - id: "state_collect_order_info"
    actions:
      - type: respond
        text: |
          å¥½çš„ï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“è¦æŸ¥è¯¢çš„è®¢å•ï¼š
          - å¦‚æœæƒ³çœ‹å…¨éƒ¨è®¢å•ï¼Œå¯ä»¥è¯´â€œæŸ¥çœ‹æˆ‘çš„è®¢å•â€
          - å¦‚æœåªæŸ¥æŸä¸€å•ï¼Œè¯·ç›´æ¥è¾“å…¥è®¢å•å·ï¼ˆå¦‚ï¼šA1234567890ï¼‰
          - å¦‚æœä¸è®°å¾—è®¢å•å·ï¼Œå¯ä»¥æè¿°â€œå¤§è‡´æ—¶é—´ + å•†å“åç§°â€ï¼Œä¾‹å¦‚â€œä¸Šå‘¨ä¹°çš„ä¸€ä¸ªæ°´æ¯â€
      - type: wait_for_input
    transitions:
      - condition:
          all:
            - type: regex
              value: ".*(æ˜¨å¤©|å‰å¤©|ä¸Šå‘¨|ä¸Šä¸ªæœˆ|æœ€è¿‘|åˆšæ‰|åˆšåˆš|ä¸Šæ¬¡|ä¹°çš„|ä¹°äº†|ä¸‹å•).*"
        target: "state_search_order_by_info"
      - condition:
          all:
            - type: regex
              value: ".*(æ‰€æœ‰|å…¨éƒ¨|æˆ‘çš„).*è®¢å•.*"
        target: "state_list_all_orders"
      - condition:
          all:
            - type: regex
              value: "[A-Z0-9]{8,12}"
        target: "state_query_specific_order"
      - target: "state_invalid_order_format"

  - id: "state_search_order_by_info"
    actions:
      - type: extract_variable
        source: user_input
        regex: ".*(?P<order_keyword>[\\u4e00-\\u9fa5A-Za-z0-9]+).*"
        target: "session.order_keyword"
      - type: api_call
        endpoint: "database://orders/search"
        params:
          keyword: "{{session.order_keyword}}"
        save_to: "session.user_orders"
      - type: respond
        text: |
          æˆ‘æ ¹æ®æ‚¨æä¾›çš„ä¿¡æ¯ä¸ºæ‚¨æŸ¥åˆ°äº†è¿™äº›è®¢å•ï¼ˆæœ€å¤šæ˜¾ç¤ºæœ€è¿‘10æ¡ï¼‰ï¼š
          {{session.order_list_text}}

          å¦‚æœè¦æŸ¥çœ‹æŸä¸€å•çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·ç›´æ¥è¾“å…¥å¯¹åº”çš„è®¢å•å·ï¼ˆå¦‚ï¼šA1234567890ï¼‰ã€‚
    transitions:
      - target: "state_collect_order_info"

  - id: "state_list_all_orders"
    actions:
      - type: api_call
        endpoint: "database://orders/list"
        params:
          user_id: "U001"
        save_to: "session.user_orders"
      - type: respond
        text: |
          æ‚¨çš„è®¢å•åˆ—è¡¨å¦‚ä¸‹ï¼š
          {{session.order_list_text}}

          è¯·å‘Šè¯‰æˆ‘è®¢å•å·ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æŸ¥è¯¢è¯¦ç»†ä¿¡æ¯ã€‚
    transitions:
      - target: "state_collect_order_info"

  - id: "state_query_specific_order"
    actions:
      - type: extract_variable
        source: user_input
        regex: "(?P<order_id>[A-Z0-9]{8,12})"
        target: "session.order_id"
      - type: api_call
        endpoint: "database://orders/get"
        params:
          order_id: "{{session.order_id}}"
        save_to: "session.current_order"
      - type: respond
        text: |
          ğŸ“¦ è®¢å•è¯¦æƒ…

          è®¢å•å·ï¼š{{session.current_order.order_id}}
          å•†å“åç§°ï¼š{{session.current_order.product_name}}
          æ•°é‡ï¼š{{session.current_order.quantity}} ä»¶
          æ€»ä»·ï¼šÂ¥{{session.current_order.total_price}}
          è®¢å•çŠ¶æ€ï¼š{{session.order_status_text}}
          é…é€åœ°å€ï¼š{{session.current_order.shipping_address}}
          {{session.tracking_info}}

          æ‚¨éœ€è¦å…¶ä»–å¸®åŠ©å—ï¼Ÿ
    transitions:
      - condition:
          all:
            - type: regex
              value: ".*(å–æ¶ˆ|ä¸è¦|é€€).*"
        target: "state_confirm_cancel"
      - condition:
          all:
            - type: regex
              value: ".*(é€€æ¬¾|é€€è´§).*"
        target: "state_redirect_to_refund"
      - target: "state_end_order_management"

  - id: "state_no_order_id_help"
    actions:
      - type: respond
        text: |
          æ²¡å…³ç³»ï¼Œå¦‚æœä¸€æ—¶æ‰¾ä¸åˆ°è®¢å•å·ï¼Œå¯ä»¥ï¼š
          1. åœ¨â€œæˆ‘çš„è®¢å•â€é¡µé¢ã€çŸ­ä¿¡æˆ–é‚®ä»¶ä¸­æŸ¥çœ‹ï¼›
          2. è”ç³»äººå·¥å®¢æœï¼Œç”±äººå·¥å¸®æ‚¨æŸ¥è¯¢ã€‚

          å½“å‰ç³»ç»Ÿåªèƒ½é€šè¿‡è®¢å•å·æˆ–è´¦å·ä¸‹çš„è®¢å•åˆ—è¡¨è¿›è¡ŒæŸ¥è¯¢å“¦ã€‚
    transitions:
      - target: "state_collect_order_info"

  - id: "state_phone_not_supported"
    actions:
      - type: respond
        text: |
          æˆ‘ç›®å‰æ— æ³•ç›´æ¥é€šè¿‡æ‰‹æœºå·æŸ¥è¯¢è®¢å•ã€‚
          å»ºè®®æ‚¨å…ˆåœ¨â€œæˆ‘çš„è®¢å•â€é¡µé¢æ‰¾åˆ°è®¢å•å·ï¼ˆå¦‚ï¼šA1234567890ï¼‰ï¼Œ
          æˆ–è”ç³»äººå·¥å®¢æœååŠ©æŸ¥è¯¢ã€‚æ‰¾åˆ°è®¢å•å·åå†å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æŸ¥è¯¢è¯¦æƒ…ã€‚
    transitions:
      - target: "state_collect_order_info"

  - id: "state_confirm_cancel"
    actions:
      - type: respond
        text: |
          æ‚¨ç¡®å®šè¦å–æ¶ˆè®¢å• {{session.order_id}} å—ï¼Ÿ

          è®¢å•çŠ¶æ€ï¼š{{session.order_status_text}}

          æç¤ºï¼š
          - å·²å‘è´§çš„è®¢å•æ— æ³•å–æ¶ˆï¼Œéœ€è¦ç”³è¯·é€€è´§
          - å–æ¶ˆåæ— æ³•æ¢å¤

          è¯·å›å¤â€œç¡®è®¤å–æ¶ˆâ€æˆ–â€œä¸å–æ¶ˆâ€
    transitions:
      - condition:
          all:
            - type: regex
              value: ".*(ç¡®è®¤|æ˜¯çš„|ç¡®å®š).*å–æ¶ˆ.*"
        target: "state_cancel_order"
      - target: "state_end_order_management"

  - id: "state_cancel_order"
    actions:
      - type: api_call
        endpoint: "database://orders/update_status"
        params:
          order_id: "{{session.order_id}}"
          status: "cancelled"
        save_to: "session.cancel_result"
      - type: respond
        text: |
          {{'è®¢å•å–æ¶ˆæˆåŠŸ' if session.cancel_result.success else 'è®¢å•å–æ¶ˆå¤±è´¥'}}
          è®¢å• {{session.order_id}} çŠ¶æ€å·²æ›´æ–°ã€‚
          {{'é€€æ¬¾å°†åœ¨3-5ä¸ªå·¥ä½œæ—¥å†…åŸè·¯è¿”å›ã€‚' if session.cancel_result.success else 'è¯·ç¨åé‡è¯•æˆ–è”ç³»äººå·¥å®¢æœã€‚'}}
    transitions:
      - target: "state_end_order_management"

  - id: "state_redirect_to_refund"
    actions:
      - type: respond
        text: |
          å¥½çš„ï¼Œå·²å‘è´§çš„è®¢å•éœ€è¦é€šè¿‡é€€æ¬¾æµç¨‹å¤„ç†ã€‚

          æˆ‘å°†ä¸ºæ‚¨è½¬æ¥åˆ°é€€æ¬¾æœåŠ¡...
          ï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°é€€æ¬¾æµç¨‹ï¼‰
    transitions:
      - target: "state_end_order_management"

  - id: "state_invalid_order_format"
    actions:
      - type: respond
        text: |
          æŠ±æ­‰ï¼Œè®¢å•å·æ ¼å¼ä¸æ­£ç¡®ã€‚

          è®¢å•å·æ ¼å¼ç¤ºä¾‹ï¼šA1234567890ï¼ˆ1ä¸ªå­—æ¯+10ä¸ªæ•°å­—ï¼‰

          è¯·é‡æ–°è¾“å…¥æ‚¨çš„è®¢å•å·ï¼Œæˆ–è€…è¯´â€œæŸ¥çœ‹æˆ‘çš„è®¢å•â€ã€‚
    transitions:
      - condition:
          all:
            - type: regex
              value: "[A-Z0-9]{8,12}"
        target: "state_query_specific_order"
      - target: "state_collect_order_info"

  - id: "state_end_order_management"
    actions:
      - type: respond
        text: "æ„Ÿè°¢å’¨è¯¢ï¼Œè¿˜æœ‰å…¶ä»–éœ€è¦å¸®åŠ©çš„å—ï¼Ÿ"
    transitions:
      # ç»“æŸåä»»æ„è¾“å…¥éƒ½ä¼šå›åˆ°è®¢å•ç®¡ç†å…¥å£ï¼Œé¿å…æ­»è·¯
      - target: "state_start_order_management"
